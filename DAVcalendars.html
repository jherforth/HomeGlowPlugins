<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CalDAV Calendars</title>
  <link rel="stylesheet" href="/index.css">
  <style>
    * { background: transparent !important; background-color: transparent !important; background-image: none !important; }
    body {
      background: transparent !important;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0.75rem;
      box-sizing: border-box;
      font-size: 0.85rem;
      color: #333;
    }
    [data-theme="dark"] body { color: #a6a6d1; }

    .widget-container {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      border-radius: 12px;
      padding: 0.5rem;
      width: 100%;
      max-height: calc(100vh - 1.5rem);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .widget-title { font-size: 1.2rem; font-weight: 700; margin: 0; color: inherit; }

    .calendars-list { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
    .calendar-tag {
      background: rgba(0,0,0,0.1) !important;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    [data-theme="dark"] .calendar-tag { background: rgba(255,255,255,0.1) !important; }

    .events-list {
      flex: 1;
      overflow-y: auto;
      text-align: left;
      padding: 0.5rem;
      background: rgba(0,0,0,0.03) !important;
      border-radius: 8px;
    }
    [data-theme="dark"] .events-list { background: rgba(255,255,255,0.05) !important; }

    .event {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    [data-theme="dark"] .event { border-bottom-color: rgba(255,255,255,0.1); }
    .event:last-child { border-bottom: none; }
    .event-summary { font-weight: 600; margin-bottom: 0.25rem; }
    .event-time { font-size: 0.75rem; opacity: 0.8; }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .custom-button {
      background: linear-gradient(45deg, #00ddeb, #ff6b6b) !important;
      color: #333 !important;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    [data-theme="dark"] .custom-button {
      background: linear-gradient(45deg, #2e2767, #620808) !important;
      color: #a6a6d1 !important;
    }
    .custom-button:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .custom-button.small { padding: 6px 12px; font-size: 0.75rem; }

    .error { color: #dc3545; }
    [data-theme="dark"] .error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="widget-container">
    <h1 class="widget-title">Calendars</h1>

    <div id="setup" style="text-align:center;">
      <button id="addCalendar" class="custom-button">+ Add CalDAV Calendar</button>
      <button id="refresh" class="custom-button" style="display:none;">Refresh</button>
    </div>

    <div id="calendars" class="calendars-list"></div>
    <div id="events" class="events-list" style="display:none;"></div>

    <div id="pagination" class="pagination" style="display:none;">
      <button id="prevPage" class="custom-button small">‹ Prev</button>
      <span id="pageInfo"></span>
      <button id="nextPage" class="custom-button small">Next ›</button>
    </div>

    <div id="status" style="text-align:center; font-size:0.8rem; opacity:0.8;"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const theme = params.get('theme');
      if (theme === 'dark' || theme === 'light') {
        document.documentElement.setAttribute('data-theme', theme);
      }
      const isTransparent = params.get('transparent') === 'true';
      if (isTransparent) {
        document.body.style.background = 'transparent';
 new URLSearchParams(window.location.search);
        const container = document.querySelector('.widget-container');
        if (container) {
          container.style.background = 'transparent';
          container.style.boxShadow = 'none';
          container.style.backdropFilter = 'none';
          container.style.border = 'none';
        }
      }

      // ---------- Persistent storage (localStorage) ----------
      const STORAGE_KEY = 'caldav_widget_calendars';
      let calendars = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let allEvents = [];
      let currentPage = 1;
      const EVENTS_PER_PAGE = 10;

      const elements = {
        setup: document.getElementById('setup'),
        addBtn: document.getElementById('addCalendar'),
        refreshBtn: document.getElementById('refresh'),
        calendarsDiv: document.getElementById('calendars'),
        eventsDiv: document.getElementById('events'),
        pagination: document.getElementById('pagination'),
        prevBtn: document.getElementById('prevPage'),
        nextBtn: document.getElementById('nextPage'),
        pageInfo: document.getElementById('pageInfo'),
        status: document.getElementById('status')
      };

      // ---------- Helpers ----------
      const saveCalendars = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(calendars));
      const setStatus = (msg, isError = false) => {
        elements.status.textContent = msg;
        elements.status.className = isError ? 'error' : '';
      };

      const renderCalendars = () => {
        elements.calendarsDiv.innerHTML = '';
        calendars.forEach((cal, i) => {
          const tag = document.createElement('span');
          tag.className = 'calendar-tag';
          tag.textContent = cal.name || `Calendar ${i+1}`;
          const remove = document.createElement('span');
          remove.textContent = ' ×';
          remove.style.cursor = 'pointer';
          remove.style.marginLeft = '6px';
          remove.onclick = () => {
            if (confirm(`Remove "${cal.name || 'this calendar'}"?`)) {
              calendars.splice(i, 1);
              saveCalendars();
              renderCalendars();
              loadAllEvents();
            }
          };
          tag.appendChild(remove);
          elements.calendarsDiv.appendChild(tag);
        });
      };

      const renderEvents = () => {
        const start = (currentPage - 1) * EVENTS_PER_PAGE;
        const end = start + EVENTS_PER_PAGE;
        const pageEvents = allEvents.slice(start, end);

        elements.eventsDiv.innerHTML = '';
        if (pageEvents.length === 0) {
          elements.eventsDiv.innerHTML = '<p>No upcoming events.</p>';
          elements.pagination.style.display = 'none';
          return;
        }

        pageEvents.forEach(ev => {
          const div = document.createElement('div');
          div.className = 'event';

          const summary = document.createElement('div');
          summary.className = 'event-summary';
          summary.textContent = ev.summary || '(No title)';

          const time = document.createElement('div');
          time.className = 'event-time';
          if (ev.isAllDay) {
            time.textContent = formatDate(ev.start);
          } else {
            time.textContent = `${formatDate(ev.start)} ${formatTime(ev.start)} – ${ev.end ? formatTime(ev.end) : ''}`;
          }

          div.append(summary, time);
          elements.eventsDiv.appendChild(div);
        });

        // Pagination
        const totalPages = Math.ceil(allEvents.length / EVENTS_PER_PAGE);
        elements.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        elements.prevBtn.disabled = currentPage === 1;
        elements.nextBtn.disabled = currentPage === totalPages;
        elements.pagination.style.display = totalPages > 1 ? 'flex' : 'none';
      };

      const formatDate = d => d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      const formatTime = d => d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });

      // ---------- CalDAV fetching ----------
      async function fetchCalendar(cal) {
        setStatus(`Fetching ${cal.name || 'calendar'}…`);
        try {
          // Basic + Digest auth supported by most servers
          const resp = await fetch(cal.url, {
            headers: {
              'Authorization': 'Basic ' + btoa(`${cal.username}:${cal.password}`),
              'Depth': '1',
              'Content-Type': 'text/calendar'
            }
          });

          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

          const ics = await resp.text();
          return parseICS(ics, cal.name);
        } catch (e) {
          console.error(e);
          setStatus(`Failed: ${cal.name || 'calendar'}`, true);
          return [];
        }
      }

      // Very small ICS parser (handles most common VEVENT fields)
      function parseICS(data, calendarName) {
        const events = [];
        const lines = data.replace(/\r\n /g, ' ').split('\n');
        let current = null;

        lines.forEach(line => {
          line = line.trim();
          if (line === 'BEGIN:VEVENT') {
            current = { calendar: calendarName };
          } else if (line.startsWith('SUMMARY:')) {
            current.summary = line.slice(8);
          } else if (line.startsWith('DTSTART;VALUE=DATE:')) {
            current.start = parseDate(line.slice(19));
            current.isAllDay = true;
          } else if (line.startsWith('DTSTART:')) {
            current.start = parseDateTime(line.slice(8));
          } else if (line.startsWith('DTEND;VALUE=DATE:')) {
            current.end = parseDate(line.slice(17));
          } else if (line.startsWith('DTEND:')) {
            current.end = parseDateTime(line.slice(6));
          } else if (line === 'END:VEVENT' && current) {
            if (current.start && current.start > new Date()) {
              events.push(current);
            }
            current = null;
          }
        });

        return events.sort((a, b) => a.start - b.start);
      }

      function parseDate(yyyymmdd) {
        const y = parseInt(yyyymmdd.slice(0,4)), m = parseInt(yyyymmdd.slice(4,6))-1, d = parseInt(yyyymmdd.slice(6,8));
        return new Date(y, m, d);
      }

      function parseDateTime(str) {
        // Handles 20250101T123000Z and 20250101T123000
        if (str.endsWith('Z')) str = str.slice(0,-1);
        const y = +str.slice(0,4), m = +str.slice(4,6)-1, d = +str.slice(6,8);
        const hh = +str.slice(9,11), mm = +str.slice(11,13), ss = +str.slice(13,15) || 0;
        return new Date(y, m, d, hh, mm, ss);
      }

      async function loadAllEvents() {
        if (calendars.length === 0) {
          elements.eventsDiv.style.display = 'none';
          elements.refreshBtn.style.display = 'none';
          setStatus('No calendars added yet.');
          return;
        }

        allEvents = [];
        for (const cal of calendars) {
          const evs = await fetchCalendar(cal);
          allEvents.push(...evs.map(e => ({ ...e, calendar: cal.name })));
        }
        allEvents.sort((a, b) => a.start - b.start);
        currentPage = 1;
        renderEvents();
        elements.eventsDiv.style.display = 'block';
        elements.refreshBtn.style.display = 'inline-block';
        setStatus(`Loaded ${allEvents.length} upcoming event(s)`);
      }

      // ---------- UI Actions ----------
      elements.addBtn.onclick = () => {
        const name = prompt('Calendar name (for display):', 'My Calendar');
        if (!name) return;
        const url = prompt('Full CalDAV URL (usually ends with .ics or calendar name):', 'https://');
        if (!url) return;
        const username = prompt('Username (or email):');
        const password = prompt('Password / app password:');
        if (!username || !password) return;

        calendars.push({ name, url: url.trim(), username, password });
        saveCalendars();
        renderCalendars();
        loadAllEvents();
      };

      elements.refreshBtn.onclick = () => {
        currentPage = 1;
        loadAllEvents();
      };

      elements.prevBtn.onclick = () => {
        if (currentPage > 1) { currentPage--; renderEvents(); }
      };
      elements.nextBtn.onclick = () => {
        if (currentPage * EVENTS_PER_PAGE < allEvents.length) { currentPage++; renderEvents(); }
      };

      // Initial render
      renderCalendars();
      if (calendars.length > 0) loadAllEvents();
    });
  </script>
</body>
</html>
