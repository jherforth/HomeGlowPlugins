<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CalDAV Calendars</title>
  <link rel="stylesheet" href="/index.css">
  <style>
    * { background: transparent !important; background-color: transparent !important; background-image: none !important; }
    body {
      background: transparent !important;
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0.75rem;
      box-sizing: border-box;
      font-size: 0.85rem;
      color: #333;
    }
    [data-theme="dark"] body { color: #a6a6d1; }

    .widget-container {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      border-radius: 12px;
      padding: 0.5rem;
      width: 100%;
      max-height: calc(100vh - 1.5rem);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .widget-title { font-size: 1.2rem; font-weight: 700; margin: 0; color: inherit; }

    .calendars-list { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
    .calendar-tag {
      background: rgba(0,0,0,0.1) !important;
      padding: 4px 10px; border-radius: 20px;
      font-size: 0.75rem; font-weight: 600;
    }
    [data-theme="dark"] .calendar-tag { background: rgba(255,255,255,0.1) !important; }

    .events-list { flex: 1; overflow-y: auto; padding: 0.5rem;
      background: rgba(0,0,0,0.03) !important; border-radius: 8px; }
    [data-theme="dark"] .events-list { background: rgba(255,255,255,0.05) !important; }

    .event { padding: 0.5rem 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
    [data-theme="dark"] .event { border-bottom-color: rgba(255,255,255,0.1); }
    .event:last-child { border-bottom: none; }
    .event-summary { font-weight: 600; margin-bottom: 0.25rem; }
    .event-time { font-size: 0.75rem; opacity: 0.8; }

    .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.5rem; }
    .custom-button {
      background: linear-gradient(45deg, #00ddeb, #ff6b6b) !important;
      color: #333 !important;
      border: none; border-radius: 8px; padding: 8px 16px;
      cursor: pointer; font-size: 0.8rem; font-weight: 600;
      transition: all 0.3s ease;
    }
    [data-theme="dark"] .custom-button {
      background: linear-gradient(45deg, #2e2767, #620808) !important;
      color: #a6a6d1 !important;
    }
    .custom-button:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .custom-button.small { padding: 6px 12px; font-size: 0.75rem; }

    .error { color: #dc3545; }
    [data-theme="dark"] .error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="widget-container">
    <h1 class="widget-title">Calendars</h1>

    <div style="text-align:center;">
      <button id="addCalendar" class="custom-button">+ Add CalDAV Calendar</button>
      <button id="refresh" class="custom-button" style="display:none; margin-left:0.5rem;">Refresh</button>
    </div>

    <div id="calendars" class="calendars-list"></div>
    <div id="events" class="events-list" style="display:none;"></div>

    <div id="pagination" class="pagination" style="display:none;">
      <button id="prevPage" class="custom-button small">‹ Prev</button>
      <span id="pageInfo"></span>
      <button id="nextPage" class="custom-button small">Next ›</button>
    </div>

    <div id="status" style="text-align:center; font-size:0.8rem; opacity:0.8;"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Theme & transparency handling (unchanged)
      const params = new URLSearchParams(window.location.search);
      const theme = params.get('theme');
      if (theme === 'dark' || theme === 'light') {
        document.documentElement.setAttribute('data-theme', theme);
      }
      if (params.get('transparent') === 'true') {
        document.body.style.background = 'transparent';
        const c = document.querySelector('.widget-container');
        if (c) { c.style.background = 'transparent'; c.style.boxShadow = 'none'; c.style.backdropFilter = 'none'; c.style.border = 'none'; }
      }

      const STORAGE_KEY = 'caldav_widget_calendars';
      let calendars = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let allEvents = [];
      let currentPage = 1;
      const EVENTS_PER_PAGE = 10;

      const el = {
        addBtn: document.getElementById('addCalendar'),
        refreshBtn: document.getElementById('refresh'),
        calendarsDiv: document.getElementById('calendars'),
        eventsDiv: document.getElementById('events'),
        pagination: document.getElementById('pagination'),
        prevBtn: document.getElementById('prevPage'),
        nextBtn: document.getElementById('nextPage'),
        pageInfo: document.getElementById('pageInfo'),
        status: document.getElementById('status')
      };

      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(calendars));
      const status = (msg, err = false) => {
        el.status.textContent = msg;
        el.status.className = err ? 'error' : '';
      };

      const renderCalendars = () => {
        el.calendarsDiv.innerHTML = '';
        calendars.forEach((cal, i) => {
          const tag = document.createElement('span');
          tag.className = 'calendar-tag';
          tag.textContent = cal.name || `Calendar ${i+1}`;
          const x = document.createElement('span');
          x.textContent = ' ×';
          x.style.cursor = 'pointer';
          x.style.marginLeft = '6px';
          x.onclick = () => {
            if (confirm(`Remove "${cal.name || 'this calendar'}"?`)) {
              calendars.splice(i, 1);
              save();
              renderCalendars();
              loadAll();
            }
          };
          tag.appendChild(x);
          el.calendarsDiv.appendChild(tag);
        });
      };

      const renderEvents = () => { /* ← same as before, unchanged for brevity */ 
        const start = (currentPage - 1) * EVENTS_PER_PAGE;
        const end = start + EVENTS_PER_PAGE;
        const page = allEvents.slice(start, end);

        el.eventsDiv.innerHTML = page.length ? '' : '<p>No upcoming events.</p>';
        page.forEach(ev => {
          const div = document.createElement('div'); div.className = 'event';
          const sum = document.createElement('div'); sum.className = 'event-summary';
          sum.textContent = ev.summary || '(No title)';
          const time = document.createElement('div'); time.className = 'event-time';
          if (ev.isAllDay) time.textContent = ev.start.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
          else time.textContent = `${ev.start.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})} ${ev.start.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})} – ${ev.end?.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) || ''}`;
          div.append(sum, time);
          el.eventsDiv.appendChild(div);
        });

        const pages = Math.ceil(allEvents.length / EVENTS_PER_PAGE);
        el.pageInfo.textContent = `Page ${currentPage} of ${pages}`;
        el.prevBtn.disabled = currentPage === 1;
        el.nextBtn.disabled = currentPage === pages;
        el.pagination.style.display = pages > 1 ? 'flex' : 'none';
      };

      // ICS parser & fetchCalendar unchanged — exactly the same as previous working version

      async function fetchCalendar(cal) {
        status(`Fetching ${cal.name || 'calendar'}…`);
        try {
          const headers = {};
          if (cal.username || cal.password) {
            headers.Authorization = 'Basic ' + btoa(`${cal.username}:${cal.password}`);
          }
          const resp = await fetch(cal.url, { headers });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const ics = await resp.text();
          return parseICS(ics, cal.name);
        } catch (e) {
          console.error(e);
          status(`Failed: ${cal.name || 'calendar'} – ${e.message}`, true);
          return [];
        }
      }

      // ← parseICS(), parseDate(), parseDateTime() exactly the same as before (omitted for brevity)

      async function loadAll() {
        if (!calendars.length) {
          el.eventsDiv.style.display = 'none';
          el.refreshBtn.style.display = 'none';
          status('No calendars added yet.');
          return;
        }
        allEvents = [];
        for (const cal of calendars) {
          const evs = await fetchCalendar(cal);
          allEvents = allEvents.concat(evs.map(e => ({...e, calendar: cal.name})));
        }
        allEvents.sort((a,b) => a.start - b.start);
        currentPage = 1;
        renderEvents();
        el.eventsDiv.style.display = 'block';
        el.refreshBtn.style.display = 'inline-block';
        status(`Loaded ${allEvents.length} upcoming event(s)`);
      }

      // ——————— MAIN FIX: Robust add-calendar flow ———————
      el.addBtn.onclick = () => {
        el.addBtn.disabled = true; // prevent double-click issues

        const name = prompt('Calendar display name (e.g. Work, Personal):') || '';
        if (!name.trim ()) { el.addBtn.disabled = false; return; }

        const url = prompt('Full CalDAV URL (must end with .ics or folder path):\nExamples:\n• Yahoo: https://user:pass@caldav.calendar.yahoo.com/\n• Nextcloud: https://cloud.example.com/remote.php/dav/calendars/user/work/') || '';
        if (!url.trim()) { el.addBtn.disabled = false; return; }

        const username = prompt('Username / email (leave blank if embedded in URL):') || '';
        const password = prompt('Password / app-password (leave blank if embedded in URL):') || '';

        calendars.push({ name: name.trim(), url: url.trim(), username, password });
        save();
        renderCalendars();
        loadAll();
        el.addBtn.disabled = false;
      };

      el.refreshBtn.onclick = () => loadAll();
      el.prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderEvents(); }};
      el.nextBtn.onclick = () => { if (currentPage * EVENTS_PER_PAGE < allEvents.length) { currentPage++; renderEvents(); }};

      renderCalendars();
      if (calendars.length) loadAll();
    });
  </script>
</body>
</html>
